---
title: "Freeze 5b Glycemic Traits"
output: html_notebook
---

```{r indata}
data.dir <- "/Users/amanning/Documents/Manning_Lab_Dev/ANALYSIS-FI-FG-Freeze5b/"
in.d <- read.table(paste(data.dir,"/Pooled_Glycemic_Traits_freeze5b_duplicates_20171224.ped",sep=""),sep="\t",header=T)
```


```{r}
tapply(in.d$FastingGlucose, in.d$T2D_FG, summary)

tapply(in.d$FastingInsulin, in.d$T2D_FI, summary)
```

```{r fig.height=6,fig.width=24}
library(ggplot2)
### http://www.sthda.com/english/wiki/ggplot2-density-plot-quick-start-guide-r-software-and-data-visualization

ggplot(in.d,aes(as.factor(STUDY_ANCESTRY),FastingInsulin,fill=as.factor(sex))) + geom_boxplot()
ggplot(in.d,aes(as.factor(STUDY_ANCESTRY),log(FastingInsulin),fill=as.factor(sex))) + geom_boxplot()

```


```{r fig.height=6,fig.width=24}
library(ggplot2)
### http://www.sthda.com/english/wiki/ggplot2-density-plot-quick-start-guide-r-software-and-data-visualization

ggplot(in.d,aes(as.factor(STUDY_ANCESTRY),FastingGlucose,fill=as.factor(sex))) + geom_boxplot()

```



```{r}

logFIstats <- cbind(N=with(in.d, tapply(log(in.d$FastingInsulin), list("STUDY"=in.d$STUDY_ANCESTRY), function(x){sum(!is.na(x))})),
Min=with(in.d, tapply(log(in.d$FastingInsulin), list("STUDY"=in.d$STUDY_ANCESTRY), min,na.rm=T)),
Median=with(in.d, tapply(log(in.d$FastingInsulin), list("STUDY"=in.d$STUDY_ANCESTR), median,na.rm=T)),
Mean=with(in.d, tapply(log(in.d$FastingInsulin), list("STUDY"=in.d$STUDY_ANCESTRY), mean,na.rm=T)),
SD=with(in.d, tapply(log(in.d$FastingInsulin), list("STUDY"=in.d$STUDY_ANCESTRY), sd,na.rm=T)),
Max=with(in.d, tapply(log(in.d$FastingInsulin), list("STUDY"=in.d$STUDY_ANCESTRY), max,na.rm=T)))

print(logFIstats,digits = 2)

```
```{r}

FGstats <- cbind(N=with(in.d, tapply(in.d$FastingGlucose, list("STUDY"=in.d$STUDY_ANCESTRY), function(x){sum(!is.na(x))})),
Min=with(in.d, tapply(in.d$FastingGlucose, list("STUDY"=in.d$STUDY_ANCESTRY), min,na.rm=T)),
Median=with(in.d, tapply(in.d$FastingGlucose, list("STUDY"=in.d$STUDY_ANCESTR), median,na.rm=T)),
Mean=with(in.d, tapply(in.d$FastingGlucose, list("STUDY"=in.d$STUDY_ANCESTRY), mean,na.rm=T)),
SD=with(in.d, tapply(in.d$FastingGlucose, list("STUDY"=in.d$STUDY_ANCESTRY), sd,na.rm=T)),
Max=with(in.d, tapply(in.d$FastingGlucose, list("STUDY"=in.d$STUDY_ANCESTRY), max,na.rm=T)))

print(FGstats,digits = 2)

```



in.d$logFastingInsulin <- log(in.d$FastingInsulin)


pooled.traits <- in.d[,c("Individual_ID","Family_ID","Mother_ID","Father_ID","sex","T2D","STUDY_ANCESTRY","age_FI","T2D_FI","BMI_FI","FastingInsulin","logFastingInsulin","FastingGlucose")]
cohort.traits <- in.d[,c("Individual_ID","Family_ID","Mother_ID","Father_ID","sex","T2D","STUDY_ANCESTRY","age_FI", "T2D_FI","BMI_FI","FastingInsulin","logFastingInsulin","FastingGlucose")]

pooled.traits$logFastingInsulin_adj <- NA
pooled.traits$logFastingInsulin_adj_invn <- NA

in.d.cases.FI <- !in.d$T2D_FI %in% c(0,1)
in.d.cases.FG <- !in.d$T2D_FI %in% c(0,1)

in.d.females <- in.d$sex==2
table(in.d.females)

sink("make.residuals.txt")

cohorts <- names(table(in.d$STUDY_ANCESTRY))
for(cohort in cohorts) {
	print(paste("COHORT:",cohort))
	
	in.d[which(in.d$STUDY_ANCESTRY==cohort),]

	print(paste("FASTING INSULIN"))
	tmp.FI <- make.residuals.transform("logFastingInsulin","age_FI+BMI_FI",
									in.d[which(in.d$STUDY_ANCESTRY==cohort),],
									casesTF=in.d.cases.FI[which(in.d$STUDY_ANCESTRY==cohort)],
									femaleTF=in.d.females[which(in.d$STUDY_ANCESTRY==cohort)])

	pooled.traits$logFastingInsulin_adj[which(in.d$STUDY_ANCESTRY==cohort)] <- tmp.FI[,"logFastingInsulin_adj_by_sex"]
	pooled.traits$logFastingInsulin_adj_invn[which(in.d$STUDY_ANCESTRY==cohort)] <- tmp.FI[,"logFastingInsulin_adj_invn"]

	print(paste("FASTING GLUCOSE"))

	tmp.FG <- make.residuals.transform("FastingGlucose","age_FG+BMI_FG",
									in.d[which(in.d$STUDY_ANCESTRY==cohort),],
									casesTF=in.d.cases.FG[which(in.d$STUDY_ANCESTRY==cohort)],
									femaleTF=in.d.females[which(in.d$STUDY_ANCESTRY==cohort)])

	pooled.traits$FastingGlucose_adj[which(in.d$STUDY_ANCESTRY==cohort)] <- tmp.FG[,"FastingGlucose_adj_by_sex"]
	pooled.traits$FastingGlucose_adj_invn[which(in.d$STUDY_ANCESTRY==cohort)] <- tmp.FG[,"FastingGlucose_adj_invn"]


	tmp.cohort.traits.FI <- cbind(logFastingInsulin_adj=rep(NA,nrow(pooled.traits)),
								logFastingInsulin_adj_invn=rep(NA,nrow(pooled.traits)))
	
	tmp.cohort.traits.FI[which(in.d$STUDY_ANCESTRY==cohort),"logFastingInsulin_adj"] <- tmp.FI[,"logFastingInsulin_adj_by_sex"]
	tmp.cohort.traits.FI[which(in.d$STUDY_ANCESTRY==cohort),"logFastingInsulin_adj_invn"] <- tmp.FI[,"logFastingInsulin_adj_invn"]
	colnames(tmp.cohort.traits.FI) <- paste(colnames(tmp.cohort.traits.FI),"_",cohort,sep="")

	tmp.cohort.traits.FG <- cbind(FastingGlucose_adj=rep(NA,nrow(pooled.traits)),
								FastingGlucose_adj_invn=rep(NA,nrow(pooled.traits)))
	
	tmp.cohort.traits.FG[which(in.d$STUDY_ANCESTRY==cohort),"FastingGlucose_adj"] <- tmp.FG[,"FastingGlucose_adj_by_sex"]
	tmp.cohort.traits.FG[which(in.d$STUDY_ANCESTRY==cohort),"FastingGlucose_adj_invn"] <- tmp.FG[,"FastingGlucose_adj_invn"]
	colnames(tmp.cohort.traits.FG) <- paste(colnames(tmp.cohort.traits.FG),"_",cohort,sep="")

						
	cohort.traits <- cbind(cohort.traits,tmp.cohort.traits.FI,tmp.cohort.traits.FG)
	
}
sink()

write.table(pooled.traits,"pooled.traits.tsv",col.names=T,row.names=F,sep="\t")
write.table(cohort.traits,"cohort.traits.tsv",col.names=T,row.names=F,sep="\t")

pdf("residuals.pdf",width=10,height=6);
ggplot(pooled.traits,aes(as.factor(sex),logFastingInsulin)) + geom_boxplot() 
ggplot(pooled.traits,aes(as.factor(sex),logFastingInsulin_adj)) + geom_boxplot() 
ggplot(pooled.traits,aes(as.factor(sex),logFastingInsulin_adj_invn)) + geom_boxplot()

ggplot(pooled.traits,aes(x=logFastingInsulin,color=as.factor(sex))) + geom_density() + facet_grid(STUDY_ANCESTRY ~ .)
ggplot(pooled.traits,aes(x=logFastingInsulin_adj,color=as.factor(sex))) + geom_density() + facet_grid(STUDY_ANCESTRY ~ .)
ggplot(pooled.traits,aes(x=logFastingInsulin_adj_invn,color=as.factor(sex))) + geom_density() + facet_grid(STUDY_ANCESTRY ~ .)

ggplot(pooled.traits,aes(as.factor(sex),FastingGlucose)) + geom_boxplot() 
ggplot(pooled.traits,aes(as.factor(sex),FastingGlucose_adj)) + geom_boxplot() 
ggplot(pooled.traits,aes(as.factor(sex),FastingGlucose_adj_invn)) + geom_boxplot()

ggplot(pooled.traits,aes(x=FastingGlucose,color=as.factor(sex))) + geom_density() + facet_grid(STUDY_ANCESTRY ~ .)
ggplot(pooled.traits,aes(x=FastingGlucose_adj,color=as.factor(sex))) + geom_density() + facet_grid(STUDY_ANCESTRY ~ .)
ggplot(pooled.traits,aes(x=FastingGlucose_adj_invn,color=as.factor(sex))) + geom_density() + facet_grid(STUDY_ANCESTRY ~ .)


dev.off()



